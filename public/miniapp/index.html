<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Dataflow - Mini App</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            background: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #000000);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
        }
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
        }
        .spinner {
            border: 3px solid rgba(139, 92, 246, 0.2);
            border-radius: 50%;
            border-top: 3px solid #8b5cf6;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // Inicializar Telegram WebApp
        const tg = window.Telegram.WebApp;
        tg.ready();
        tg.expand();

        // Configuraci√≥n de API
        const initData = tg.initData || '';
        const apiHeaders = {
            'Content-Type': 'application/json',
            'X-Telegram-Init-Data': initData
        };

        // Utilidades
        const formatMoney = (amount) => {
            return new Intl.NumberFormat('es-PY', {
                style: 'currency',
                currency: 'PYG',
                minimumFractionDigits: 0
            }).format(amount);
        };

        const formatDate = (dateString) => {
            if (!dateString) return '-';
            return new Date(dateString).toLocaleDateString('es-PY', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric'
            });
        };

        // API Service
        const api = {
            async fetch(endpoint, options = {}) {
                try {
                    const response = await fetch(`/api/miniapp${endpoint}`, {
                        ...options,
                        headers: {
                            ...apiHeaders,
                            ...options.headers
                        }
                    });

                    const data = await response.json();

                    if (!response.ok) {
                        throw new Error(data.error || 'Error en la petici√≥n');
                    }

                    return data;
                } catch (error) {
                    tg.showAlert('‚ùå ' + error.message);
                    throw error;
                }
            },

            getDashboard: () => api.fetch('/dashboard'),
            getDocuments: (page = 1) => api.fetch(`/documents?page=${page}`),
            getDocument: (id) => api.fetch(`/documents/${id}`),
            consultCDC: (cdc, entityId) => api.fetch('/cdc/consult', {
                method: 'POST',
                body: JSON.stringify({ cdc, entity_id: entityId, auto_save: true })
            }),
            getEntities: () => api.fetch('/entities'),
            exportVat: (month, year, entityId) => api.fetch('/export/vat-liquidation', {
                method: 'POST',
                body: JSON.stringify({ month, year, entity_id: entityId })
            })
        };

        // Componente Dashboard
        function Dashboard({ onNavigate }) {
            const [stats, setStats] = useState(null);
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                loadDashboard();
            }, []);

            const loadDashboard = async () => {
                try {
                    const response = await api.getDashboard();
                    setStats(response.data);
                } catch (error) {
                    console.error(error);
                } finally {
                    setLoading(false);
                }
            };

            if (loading) {
                return <div className="loading"><div className="spinner"></div></div>;
            }

            if (!stats) {
                return (
                    <div className="p-4">
                        <div className="text-center text-red-600">Error al cargar dashboard</div>
                    </div>
                );
            }

            const current = stats.current_month;
            const previous = stats.previous_month;
            const growth = previous.total_invoices > 0
                ? ((current.total_invoices - previous.total_invoices) / previous.total_invoices * 100).toFixed(1)
                : 0;

            return (
                <div className="p-4 pb-20 fade-in">
                    {/* Header */}
                    <div className="mb-6">
                        <h1 className="text-2xl font-bold text-purple-700">üìä Dashboard</h1>
                        <p className="text-gray-600">{current.name}</p>
                    </div>

                    {/* M√©tricas principales */}
                    <div className="grid grid-cols-2 gap-4 mb-6">
                        <div className="bg-purple-100 p-4 rounded-lg">
                            <div className="text-3xl font-bold text-purple-700">
                                {current.total_invoices}
                            </div>
                            <div className="text-sm text-gray-600">Facturas</div>
                            {growth !== 0 && (
                                <div className={`text-xs mt-1 ${growth > 0 ? 'text-green-600' : 'text-red-600'}`}>
                                    {growth > 0 ? '‚Üë' : '‚Üì'} {Math.abs(growth)}% vs mes anterior
                                </div>
                            )}
                        </div>

                        <div className="bg-green-100 p-4 rounded-lg">
                            <div className="text-2xl font-bold text-green-700">
                                {formatMoney(current.total_iva_credito).replace('PYG', '‚Ç≤')}
                            </div>
                            <div className="text-sm text-gray-600">IVA Cr√©dito</div>
                        </div>

                        <div className="bg-blue-100 p-4 rounded-lg">
                            <div className="text-3xl font-bold text-blue-700">
                                {current.validated_set}
                            </div>
                            <div className="text-sm text-gray-600">Validadas SET</div>
                        </div>

                        <div className="bg-yellow-100 p-4 rounded-lg">
                            <div className="text-3xl font-bold text-yellow-700">
                                {current.pending_validation}
                            </div>
                            <div className="text-sm text-gray-600">Pendientes</div>
                        </div>
                    </div>

                    {/* Desglose IVA */}
                    <div className="bg-white rounded-lg shadow-md p-4 mb-6">
                        <h3 className="font-bold text-lg mb-3">üí∞ Desglose de IVA</h3>

                        <div className="space-y-3">
                            <div className="flex justify-between items-center">
                                <span className="text-gray-700">IVA 10%</span>
                                <div className="text-right">
                                    <div className="font-bold text-purple-700">
                                        {formatMoney(current.breakdown.iva_10.iva).replace('PYG', '‚Ç≤')}
                                    </div>
                                    <div className="text-xs text-gray-500">
                                        Base: {formatMoney(current.breakdown.iva_10.base).replace('PYG', '‚Ç≤')}
                                    </div>
                                </div>
                            </div>

                            <div className="flex justify-between items-center">
                                <span className="text-gray-700">IVA 5%</span>
                                <div className="text-right">
                                    <div className="font-bold text-purple-700">
                                        {formatMoney(current.breakdown.iva_5.iva).replace('PYG', '‚Ç≤')}
                                    </div>
                                    <div className="text-xs text-gray-500">
                                        Base: {formatMoney(current.breakdown.iva_5.base).replace('PYG', '‚Ç≤')}
                                    </div>
                                </div>
                            </div>

                            <div className="flex justify-between items-center">
                                <span className="text-gray-700">Exentas</span>
                                <div className="font-bold text-gray-600">
                                    {formatMoney(current.breakdown.exentas).replace('PYG', '‚Ç≤')}
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* Alertas */}
                    {stats.alerts && stats.alerts.length > 0 && (
                        <div className="bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-6">
                            <h3 className="font-bold text-yellow-800 mb-2">‚ö†Ô∏è Alertas</h3>
                            {stats.alerts.map((alert, idx) => (
                                <div key={idx} className="text-sm text-yellow-700 mb-1">
                                    ‚Ä¢ {alert.message}
                                </div>
                            ))}
                        </div>
                    )}

                    {/* Botones de acci√≥n r√°pida */}
                    <div className="grid grid-cols-2 gap-3">
                        <button
                            onClick={() => onNavigate('cdc')}
                            className="bg-purple-600 text-white py-3 px-4 rounded-lg font-bold shadow-md active:scale-95 transition-transform"
                        >
                            üîç Consultar CDC
                        </button>
                        <button
                            onClick={() => onNavigate('documents')}
                            className="bg-blue-600 text-white py-3 px-4 rounded-lg font-bold shadow-md active:scale-95 transition-transform"
                        >
                            üìÑ Ver Facturas
                        </button>
                    </div>
                </div>
            );
        }

        // Componente Consulta CDC
        function CDCConsult({ onNavigate }) {
            const [cdc, setCdc] = useState('');
            const [entities, setEntities] = useState([]);
            const [selectedEntity, setSelectedEntity] = useState('');
            const [loading, setLoading] = useState(false);
            const [result, setResult] = useState(null);

            useEffect(() => {
                loadEntities();
            }, []);

            const loadEntities = async () => {
                try {
                    const response = await api.getEntities();
                    setEntities(response.data);
                    if (response.data.length > 0) {
                        setSelectedEntity(response.data[0].id);
                    }
                } catch (error) {
                    console.error(error);
                }
            };

            const handleConsult = async () => {
                if (cdc.length !== 44) {
                    tg.showAlert('‚ö†Ô∏è El CDC debe tener 44 d√≠gitos');
                    return;
                }

                if (!selectedEntity) {
                    tg.showAlert('‚ö†Ô∏è Selecciona una entidad fiscal');
                    return;
                }

                setLoading(true);
                setResult(null);

                try {
                    const response = await api.consultCDC(cdc, selectedEntity);
                    setResult(response.data);
                    tg.showAlert('‚úÖ Factura consultada y guardada exitosamente');
                } catch (error) {
                    console.error(error);
                } finally {
                    setLoading(false);
                }
            };

            const handleScanQR = () => {
                tg.showScanQrPopup({
                    text: 'Escanea el c√≥digo QR de la factura electr√≥nica'
                }, (text) => {
                    // Extraer CDC del texto del QR
                    const cdcMatch = text.match(/\d{44}/);
                    if (cdcMatch) {
                        setCdc(cdcMatch[0]);
                        tg.closeScanQrPopup();
                    } else {
                        tg.showAlert('‚ùå No se encontr√≥ un CDC v√°lido en el QR');
                    }
                });
            };

            return (
                <div className="p-4 pb-20 fade-in">
                    <div className="mb-6">
                        <h1 className="text-2xl font-bold text-purple-700">üîç Consultar CDC</h1>
                        <p className="text-gray-600 text-sm">Factura Electr√≥nica SET</p>
                    </div>

                    {/* Selecci√≥n de entidad */}
                    <div className="mb-4">
                        <label className="block text-sm font-bold mb-2 text-gray-700">
                            Entidad Fiscal
                        </label>
                        <select
                            value={selectedEntity}
                            onChange={(e) => setSelectedEntity(e.target.value)}
                            className="w-full p-3 border-2 border-gray-300 rounded-lg"
                        >
                            {entities.map(entity => (
                                <option key={entity.id} value={entity.id}>
                                    {entity.name} - RUC: {entity.ruc}
                                </option>
                            ))}
                        </select>
                    </div>

                    {/* Input CDC */}
                    <div className="mb-4">
                        <label className="block text-sm font-bold mb-2 text-gray-700">
                            C√≥digo de Control (CDC)
                        </label>
                        <input
                            type="text"
                            value={cdc}
                            onChange={(e) => setCdc(e.target.value.replace(/\D/g, '').slice(0, 44))}
                            placeholder="44 d√≠gitos del CDC"
                            maxLength={44}
                            className="w-full p-3 border-2 border-gray-300 rounded-lg text-lg tracking-wider"
                        />
                        <div className="text-xs text-gray-500 mt-1">
                            {cdc.length}/44 d√≠gitos
                        </div>
                    </div>

                    {/* Botones */}
                    <div className="space-y-3 mb-6">
                        <button
                            onClick={handleConsult}
                            disabled={loading || cdc.length !== 44}
                            className="w-full bg-purple-600 text-white py-3 rounded-lg font-bold shadow-md disabled:bg-gray-300 disabled:cursor-not-allowed active:scale-95 transition-transform"
                        >
                            {loading ? '‚è≥ Consultando en SET...' : 'üîç Consultar y Guardar'}
                        </button>

                        <button
                            onClick={handleScanQR}
                            disabled={loading}
                            className="w-full border-2 border-purple-600 text-purple-600 py-3 rounded-lg font-bold active:scale-95 transition-transform"
                        >
                            üì∑ Escanear C√≥digo QR
                        </button>
                    </div>

                    {/* Resultado */}
                    {result && result.invoice_data && (
                        <div className="bg-green-50 border-2 border-green-500 rounded-lg p-4">
                            <h3 className="font-bold text-green-800 mb-3">‚úÖ Factura Guardada</h3>

                            <div className="space-y-2 text-sm">
                                <div className="flex justify-between">
                                    <span className="text-gray-600">Emisor:</span>
                                    <span className="font-bold">{result.invoice_data.razon_social_emisor}</span>
                                </div>
                                <div className="flex justify-between">
                                    <span className="text-gray-600">RUC:</span>
                                    <span className="font-mono">{result.invoice_data.ruc_emisor}</span>
                                </div>
                                <div className="flex justify-between">
                                    <span className="text-gray-600">Factura:</span>
                                    <span className="font-mono">{result.invoice_data.numero_factura}</span>
                                </div>
                                <div className="flex justify-between">
                                    <span className="text-gray-600">Total:</span>
                                    <span className="font-bold text-green-700">
                                        {formatMoney(result.invoice_data.monto_total)}
                                    </span>
                                </div>
                                <div className="flex justify-between">
                                    <span className="text-gray-600">IVA Total:</span>
                                    <span className="font-bold text-purple-700">
                                        {formatMoney(result.invoice_data.total_iva)}
                                    </span>
                                </div>
                            </div>
                        </div>
                    )}

                    <div className="mt-6">
                        <button
                            onClick={() => onNavigate('dashboard')}
                            className="text-purple-600 font-bold"
                        >
                            ‚Üê Volver al Dashboard
                        </button>
                    </div>
                </div>
            );
        }

        // Componente Lista de Documentos
        function DocumentList({ onNavigate }) {
            const [documents, setDocuments] = useState([]);
            const [loading, setLoading] = useState(true);
            const [page, setPage] = useState(1);
            const [hasMore, setHasMore] = useState(false);

            useEffect(() => {
                loadDocuments();
            }, [page]);

            const loadDocuments = async () => {
                setLoading(true);
                try {
                    const response = await api.getDocuments(page);
                    setDocuments(response.data.data);
                    setHasMore(response.data.current_page < response.data.last_page);
                } catch (error) {
                    console.error(error);
                } finally {
                    setLoading(false);
                }
            };

            if (loading && page === 1) {
                return <div className="loading"><div className="spinner"></div></div>;
            }

            return (
                <div className="p-4 pb-20 fade-in">
                    <div className="mb-6">
                        <h1 className="text-2xl font-bold text-purple-700">üìÑ Facturas</h1>
                        <p className="text-gray-600 text-sm">Mes actual</p>
                    </div>

                    <div className="space-y-3">
                        {documents.map(doc => (
                            <div key={doc.id} className="bg-white rounded-lg shadow-md p-4 border-l-4 border-purple-500">
                                <div className="flex justify-between items-start mb-2">
                                    <div>
                                        <div className="font-bold text-gray-800">{doc.supplier_name || 'Sin nombre'}</div>
                                        <div className="text-xs text-gray-500">RUC: {doc.ruc || '-'}</div>
                                    </div>
                                    <div className="text-right">
                                        <div className="font-bold text-purple-700">
                                            {formatMoney(doc.total_amount || 0).replace('PYG', '‚Ç≤')}
                                        </div>
                                        {doc.validated && <span className="text-xs text-green-600">‚úì Validada</span>}
                                    </div>
                                </div>

                                <div className="text-sm text-gray-600">
                                    <div>Factura: {doc.invoice_number || '-'}</div>
                                    <div>Fecha: {formatDate(doc.invoice_date)}</div>
                                </div>

                                {doc.iva_credito > 0 && (
                                    <div className="mt-2 pt-2 border-t border-gray-200">
                                        <div className="text-xs text-purple-600 font-bold">
                                            IVA Cr√©dito: {formatMoney(doc.iva_credito).replace('PYG', '‚Ç≤')}
                                        </div>
                                    </div>
                                )}
                            </div>
                        ))}
                    </div>

                    {hasMore && (
                        <button
                            onClick={() => setPage(page + 1)}
                            disabled={loading}
                            className="w-full mt-4 bg-purple-100 text-purple-700 py-3 rounded-lg font-bold"
                        >
                            {loading ? 'Cargando...' : 'Cargar m√°s'}
                        </button>
                    )}

                    <div className="mt-6">
                        <button
                            onClick={() => onNavigate('dashboard')}
                            className="text-purple-600 font-bold"
                        >
                            ‚Üê Volver al Dashboard
                        </button>
                    </div>
                </div>
            );
        }

        // App Principal
        function App() {
            const [currentView, setCurrentView] = useState('dashboard');

            // Configurar colores del tema de Telegram
            useEffect(() => {
                document.body.style.backgroundColor = tg.themeParams.bg_color || '#ffffff';
                document.body.style.color = tg.themeParams.text_color || '#000000';
            }, []);

            const renderView = () => {
                switch (currentView) {
                    case 'dashboard':
                        return <Dashboard onNavigate={setCurrentView} />;
                    case 'cdc':
                        return <CDCConsult onNavigate={setCurrentView} />;
                    case 'documents':
                        return <DocumentList onNavigate={setCurrentView} />;
                    default:
                        return <Dashboard onNavigate={setCurrentView} />;
                }
            };

            return (
                <div className="min-h-screen">
                    {renderView()}
                </div>
            );
        }

        // Renderizar la aplicaci√≥n
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
